# Data Model: YouTube视频下载器与字幕处理器

## Entity Definitions

### 1. VideoInfo (视频信息)
Represents YouTube video metadata and download information.

```typescript
interface VideoInfo {
  id: string;                    // YouTube video ID
  url: string;                   // Original YouTube URL
  title: string;                 // Video title
  duration: number;              // Duration in seconds
  thumbnail: string;             // Thumbnail URL
  author: string;                // Channel name
  description?: string;          // Video description
  availableFormats: VideoFormat[]; // Available quality options
  availableSubtitles: string[];  // Available subtitle languages
  fileSize?: number;             // Estimated file size in bytes
  uploadDate?: Date;             // Video upload date
  viewCount?: number;            // View count
}

interface VideoFormat {
  formatId: string;              // YouTube format ID
  quality: string;               // e.g., "1080p", "720p"
  ext: string;                   // File extension
  fileSize?: number;             // Size in bytes
  fps?: number;                  // Frames per second
  vcodec?: string;               // Video codec
  acodec?: string;               // Audio codec
}
```

### 2. Subtitle (字幕)
Represents subtitle data for a video.

```typescript
interface Subtitle {
  id: string;                    // Unique subtitle ID
  videoId: string;               // Associated video ID
  language: string;              // Language code (e.g., 'en', 'zh-CN')
  languageName: string;          // Human-readable language name
  format: SubtitleFormat;        // SRT, VTT, ASS
  content: string;               // Subtitle file content
  isAutoGenerated: boolean;      // Whether AI-generated
  isDefault?: boolean;           // Default subtitle track
  timestamps: SubtitleEntry[];   // Time-coded entries
}

interface SubtitleEntry {
  startTime: number;             // Start time in milliseconds
  endTime: number;               // End time in milliseconds
  text: string;                  // Subtitle text
}

enum SubtitleFormat {
  SRT = 'srt',
  VTT = 'vtt',
  ASS = 'ass'
}
```

### 3. BilingualSubtitleConfig (双语字幕配置)
Configuration for bilingual subtitle display.

```typescript
interface BilingualSubtitleConfig {
  primaryLanguage: string;       // Primary language code
  secondaryLanguage: string;     // Secondary language code
  layout: SubtitleLayout;        // Display layout
  primaryFontSize: number;       // Primary subtitle font size
  secondaryFontSize: number;     // Secondary subtitle font size
  primaryColor: string;          // Primary subtitle color (hex)
  secondaryColor: string;        // Secondary subtitle color (hex)
  verticalSpacing: number;       // Pixels between subtitles
  primaryPosition: SubtitlePosition;
  secondaryPosition: SubtitlePosition;
}

enum SubtitleLayout {
  STACKED = 'stacked',          // 上下排列
  SIDE_BY_SIDE = 'side_by_side', // 左右排列
  CUSTOM = 'custom'              // 自定义位置
}

interface SubtitlePosition {
  x: number;                     // Horizontal position (%)
  y: number;                     // Vertical position (%)
  alignment: TextAlignment;      // Text alignment
}

enum TextAlignment {
  LEFT = 'left',
  CENTER = 'center',
  RIGHT = 'right'
}
```

### 4. CompressionConfig (压缩配置)
User-selected compression parameters.

```typescript
interface CompressionConfig {
  id: string;                    // Config ID
  name?: string;                 // User-defined preset name
  outputFormat: VideoFormat;     // MP4, WebM, MKV
  resolution: VideoResolution;   // Target resolution
  videoBitrate?: number;         // Video bitrate (kbps)
  audioBitrate?: number;         // Audio bitrate (kbps)
  videoCodec: string;            // e.g., 'libx264', 'libx265'
  audioCodec: string;            // e.g., 'aac', 'mp3'
  preset: CompressionPreset;     // Speed vs quality preset
  crf?: number;                  // Constant Rate Factor (0-51)
  fps?: number;                  // Target frame rate
  twoPass: boolean;              // Two-pass encoding
}

enum VideoFormat {
  MP4 = 'mp4',
  WEBM = 'webm',
  MKV = 'mkv',
  MOV = 'mov',
  AVI = 'avi'
}

enum VideoResolution {
  ORIGINAL = 'original',
  UHD_4K = '2160p',
  FHD_1080P = '1080p',
  HD_720P = '720p',
  SD_480P = '480p',
  LD_360P = '360p',
  CUSTOM = 'custom'
}

enum CompressionPreset {
  ULTRAFAST = 'ultrafast',
  SUPERFAST = 'superfast',
  VERYFAST = 'veryfast',
  FASTER = 'faster',
  FAST = 'fast',
  MEDIUM = 'medium',
  SLOW = 'slow',
  SLOWER = 'slower',
  VERYSLOW = 'veryslow'
}
```

### 5. DownloadTask (下载任务)
Current download status and progress.

```typescript
interface DownloadTask {
  id: string;                    // Task ID
  videoInfo: VideoInfo;          // Video metadata
  status: TaskStatus;            // Current status
  progress: number;              // Progress percentage (0-100)
  downloadedBytes: number;       // Bytes downloaded
  totalBytes: number;            // Total file size
  speed: number;                 // Download speed (bytes/sec)
  eta: number;                   // Estimated time (seconds)
  resumeData?: ResumeData;       // Resume information
  error?: TaskError;             // Error details if failed
  startTime: Date;               // Task start time
  endTime?: Date;                // Task completion time
  outputPath: string;            // Final output file path
  tempPath?: string;             // Temporary file path
}

interface ResumeData {
  url: string;                   // Download URL
  downloadedBytes: number;       // Bytes already downloaded
  totalBytes: number;            // Total expected bytes
  tempFile: string;              // Partial file location
  etag?: string;                 // HTTP ETag for validation
  lastModified?: string;         // Last-Modified header
}

enum TaskStatus {
  PENDING = 'pending',
  DOWNLOADING = 'downloading',
  PROCESSING_SUBTITLES = 'processing_subtitles',
  COMPRESSING = 'compressing',
  COMPLETED = 'completed',
  PAUSED = 'paused',
  FAILED = 'failed',
  CANCELLED = 'cancelled'
}

interface TaskError {
  code: string;                  // Error code
  message: string;               // Error message
  details?: any;                 // Additional error details
  timestamp: Date;               // When error occurred
}
```

### 6. ProcessingTask (处理任务)
Current processing status for subtitles and compression.

```typescript
interface ProcessingTask {
  id: string;                    // Task ID
  type: ProcessingType;          // Processing type
  status: TaskStatus;            // Current status
  progress: number;              // Progress percentage
  currentStep: string;           // Current processing step
  totalSteps: number;            // Total number of steps
  estimatedTime: number;         // Estimated remaining time (seconds)
  inputFile: string;             // Input file path
  outputFile: string;            // Output file path
  config: CompressionConfig | BilingualSubtitleConfig;
  logs: ProcessingLog[];         // Processing logs
}

enum ProcessingType {
  SUBTITLE_GENERATION = 'subtitle_generation',
  SUBTITLE_EMBEDDING = 'subtitle_embedding',
  VIDEO_COMPRESSION = 'video_compression',
  FORMAT_CONVERSION = 'format_conversion'
}

interface ProcessingLog {
  timestamp: Date;               // Log timestamp
  level: LogLevel;               // Log level
  message: string;               // Log message
  data?: any;                    // Additional data
}

enum LogLevel {
  DEBUG = 'debug',
  INFO = 'info',
  WARNING = 'warning',
  ERROR = 'error'
}
```

### 7. UserPreferences (用户偏好)
Saved user settings and preferences.

```typescript
interface UserPreferences {
  id: string;                    // User ID (for future multi-user)
  defaultOutputPath: string;     // Default save location
  defaultCompressionConfig: CompressionConfig;
  defaultSubtitleLanguages: string[]; // Preferred subtitle languages
  defaultVideoQuality: VideoResolution;
  defaultOutputFormat: VideoFormat;
  autoGenerateSubtitles: boolean;
  autoStartDownload: boolean;    // Start download immediately
  maxConcurrentDownloads: number;
  proxySettings?: ProxySettings;
  theme: AppTheme;               // UI theme
  language: string;              // UI language
  shortcuts: KeyboardShortcuts;  // Custom keyboard shortcuts
  notifications: NotificationSettings;
}

interface ProxySettings {
  enabled: boolean;
  type: 'http' | 'https' | 'socks5';
  host: string;
  port: number;
  username?: string;
  password?: string;
}

enum AppTheme {
  LIGHT = 'light',
  DARK = 'dark',
  SYSTEM = 'system'
}

interface KeyboardShortcuts {
  [action: string]: string;      // Action -> key combination
}

interface NotificationSettings {
  downloadComplete: boolean;
  subtitleGenerated: boolean;
  compressionComplete: boolean;
  errors: boolean;
  sound: boolean;
}
```

## Database Schema (SQLite)

```sql
-- Video information cache
CREATE TABLE videos (
    id TEXT PRIMARY KEY,           -- YouTube video ID
    url TEXT NOT NULL,
    title TEXT NOT NULL,
    duration INTEGER,
    thumbnail TEXT,
    author TEXT,
    metadata TEXT,                 -- JSON: full VideoInfo object
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- Download history and resume data
CREATE TABLE downloads (
    id TEXT PRIMARY KEY,           -- Task ID
    video_id TEXT NOT NULL,
    status TEXT NOT NULL,
    progress REAL DEFAULT 0,
    downloaded_bytes INTEGER DEFAULT 0,
    total_bytes INTEGER,
    resume_data TEXT,              -- JSON: ResumeData object
    output_path TEXT,
    error TEXT,                    -- JSON: TaskError object
    started_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    completed_at DATETIME,
    FOREIGN KEY (video_id) REFERENCES videos(id)
);

-- Subtitle cache
CREATE TABLE subtitles (
    id TEXT PRIMARY KEY,
    video_id TEXT NOT NULL,
    language TEXT NOT NULL,
    language_name TEXT,
    format TEXT,
    content TEXT,                  -- Full subtitle content
    is_auto_generated BOOLEAN DEFAULT 0,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (video_id) REFERENCES videos(id),
    UNIQUE(video_id, language)
);

-- User preferences
CREATE TABLE preferences (
    key TEXT PRIMARY KEY,
    value TEXT NOT NULL,           -- JSON serialized value
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- Compression presets
CREATE TABLE compression_presets (
    id TEXT PRIMARY KEY,
    name TEXT NOT NULL,
    config TEXT NOT NULL,          -- JSON: CompressionConfig
    is_default BOOLEAN DEFAULT 0,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- Processing queue
CREATE TABLE processing_queue (
    id TEXT PRIMARY KEY,
    type TEXT NOT NULL,
    status TEXT NOT NULL,
    priority INTEGER DEFAULT 0,
    input_file TEXT NOT NULL,
    output_file TEXT,
    config TEXT,                   -- JSON: processing config
    progress REAL DEFAULT 0,
    started_at DATETIME,
    completed_at DATETIME,
    error TEXT                     -- JSON: error details
);

-- Create indexes for performance
CREATE INDEX idx_downloads_status ON downloads(status);
CREATE INDEX idx_downloads_video_id ON downloads(video_id);
CREATE INDEX idx_subtitles_video_id ON subtitles(video_id);
CREATE INDEX idx_processing_queue_status ON processing_queue(status);
```

## State Management (Redux Store Structure)

```typescript
interface AppState {
  // Current task states
  currentDownload: DownloadTask | null;
  currentProcessing: ProcessingTask | null;

  // Queue management
  downloadQueue: DownloadTask[];
  processingQueue: ProcessingTask[];

  // History
  downloadHistory: DownloadTask[];

  // Cached data
  videoCache: Map<string, VideoInfo>;
  subtitleCache: Map<string, Subtitle[]>;

  // User settings
  preferences: UserPreferences;

  // UI state
  ui: {
    activeTab: string;
    selectedVideo: string | null;
    isSettingsOpen: boolean;
    notifications: Notification[];
  };

  // System status
  system: {
    isOnline: boolean;
    diskSpace: number;
    cpuUsage: number;
    memoryUsage: number;
  };
}
```

## Data Flow

1. **Video Download Flow**:
   - User inputs URL → Validate URL → Fetch VideoInfo
   - Create DownloadTask → Add to queue → Start download
   - Update progress → Handle resume if interrupted
   - Save to downloads table → Move to processing if needed

2. **Subtitle Processing Flow**:
   - Check subtitle cache → Download if available
   - Generate with Whisper if not available
   - Save to subtitles table → Prepare for embedding

3. **Compression Flow**:
   - Load CompressionConfig → Create ProcessingTask
   - Execute ffmpeg with parameters → Monitor progress
   - Save output file → Update database → Notify user

4. **Resume Flow**:
   - Load ResumeData from database → Validate partial file
   - Continue download from last byte → Merge segments
   - Update progress from resume point

---
*Data Model Design completed: 2025-09-21*